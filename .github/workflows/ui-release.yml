name: PromptoLab-UI CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'prompto-lab-ui/**'
      - '.github/workflows/ui-release.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'prompto-lab-ui/**'
      - '.github/workflows/ui-release.yml'

env:
  NODE_VERSION: '18'
  REGISTRY: ${{ secrets.DOCKER_REPO }}
  UI_DIR: 'prompto-lab-ui'

jobs:
  # Job 1: æ£€æµ‹å˜æ›´å’Œä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '<Auto>') || github.event_name == 'pull_request'
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      version: ${{ steps.extract.outputs.version }}
      module: ${{ steps.extract.outputs.module }}
      has-ui-changes: ${{ steps.changes.outputs.ui }}
      
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        id: changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å‰ç«¯æ–‡ä»¶å˜æ›´
          if git diff --name-only HEAD~1 HEAD | grep -q "^prompto-lab-ui/"; then
            echo "ui=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å‰ç«¯æ–‡ä»¶å˜æ›´"
          else
            echo "ui=false" >> $GITHUB_OUTPUT
            echo "æœªæ£€æµ‹åˆ°å‰ç«¯æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡å‰ç«¯éƒ¨ç½²"
          fi
        
      - name: æå–æäº¤ä¿¡æ¯
        id: extract
        if: steps.changes.outputs.ui == 'true'
        run: |
          commit_message="${{ github.event.head_commit.message }}"
          echo "æäº¤ä¿¡æ¯: $commit_message"
          
          # é»˜è®¤å€¼
          version="$(date +%Y%m%d-%H%M%S)"
          module="promptolab-ui"
          skip_tests="false"
          skip_build="false"
          skip_deploy="false"
          
          # è§£æå‚æ•°
          if [[ "$commit_message" =~ -v:([^\ ]*) ]]; then
            version="${BASH_REMATCH[1]}"
          fi
          
          if [[ "$commit_message" =~ -m:([^\ ]*) ]]; then
            module="${BASH_REMATCH[1]}"
          fi
          
          if [[ "$commit_message" =~ -skip:([^\ ]*) ]]; then
            skip_option="${BASH_REMATCH[1]}"
            case $skip_option in
              tests) skip_tests="true" ;;
              build) skip_build="true" ;;
              deploy) skip_deploy="true" ;;
              all) skip_tests="true"; skip_build="true"; skip_deploy="true" ;;
            esac
          fi
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "module=$module" >> $GITHUB_OUTPUT
          echo "skip-tests=$skip_tests" >> $GITHUB_OUTPUT
          echo "skip-build=$skip_build" >> $GITHUB_OUTPUT
          echo "skip-deploy=$skip_deploy" >> $GITHUB_OUTPUT
          
      - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥éƒ¨ç½²
        id: check
        if: steps.changes.outputs.ui == 'true'
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi
          
      - name: è®¾ç½®Node.js
        if: steps.changes.outputs.ui == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.UI_DIR }}/package-lock.json'
          
      - name: å®‰è£…ä¾èµ–
        if: steps.changes.outputs.ui == 'true'
        working-directory: ${{ env.UI_DIR }}
        run: npm ci
        
      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        if: steps.changes.outputs.ui == 'true' && steps.extract.outputs.skip-tests != 'true'
        working-directory: ${{ env.UI_DIR }}
        run: |
          # å¦‚æœæœ‰eslinté…ç½®
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npm run lint || echo "Lintæ£€æŸ¥å®Œæˆ"
          fi
          
      - name: ç±»å‹æ£€æŸ¥
        if: steps.changes.outputs.ui == 'true' && steps.extract.outputs.skip-tests != 'true'
        working-directory: ${{ env.UI_DIR }}
        run: npm run type-check
        
      - name: å•å…ƒæµ‹è¯•
        if: steps.changes.outputs.ui == 'true' && steps.extract.outputs.skip-tests != 'true'
        working-directory: ${{ env.UI_DIR }}
        run: |
          # å¦‚æœæœ‰æµ‹è¯•è„šæœ¬
          if npm run | grep -q "test"; then
            npm run test || echo "æµ‹è¯•å®Œæˆ"
          else
            echo "æœªé…ç½®æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•"
          fi

  # Job 2: æ„å»ºåº”ç”¨
  build:
    name: æ„å»ºå‰ç«¯åº”ç”¨
    runs-on: ubuntu-latest
    needs: code-quality
    if: needs.code-quality.outputs.should-deploy == 'true' && needs.code-quality.outputs.has-ui-changes == 'true' && needs.code-quality.result == 'success'
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.UI_DIR }}/package-lock.json'
          
      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.UI_DIR }}
        run: npm ci
        
      - name: æ„å»ºåº”ç”¨
        working-directory: ${{ env.UI_DIR }}
        run: npm run build
        
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist-files
          path: ${{ env.UI_DIR }}/dist/
          retention-days: 1

  # Job 3: æ„å»ºDockeré•œåƒ
  docker-build:
    name: æ„å»ºå‰ç«¯Dockeré•œåƒ
    runs-on: ubuntu-latest
    needs: [code-quality, build]
    if: needs.code-quality.outputs.should-deploy == 'true' && needs.code-quality.outputs.has-ui-changes == 'true' && needs.build.result == 'success'
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ui-dist-files
          path: ${{ env.UI_DIR }}/dist/
          
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ç™»å½•Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_REPO }}
          password: ${{ secrets.DOCKER_PWD }}
          
      - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.UI_DIR }}
          file: ${{ env.UI_DIR }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ needs.code-quality.outputs.module }}:${{ needs.code-quality.outputs.version }}
            ${{ env.REGISTRY }}/${{ needs.code-quality.outputs.module }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 4: éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    name: éƒ¨ç½²å‰ç«¯åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build]
    if: needs.code-quality.outputs.should-deploy == 'true' && needs.code-quality.outputs.has-ui-changes == 'true' && needs.docker-build.result == 'success'
    environment: production
    
    steps:
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_ADDRESS }}
          username: ${{ secrets.SERVER_USERNAME || 'root' }}
          password: ${{ secrets.SERVER_PWD }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -e
            
            MODULE="${{ needs.code-quality.outputs.module }}"
            VERSION="${{ needs.code-quality.outputs.version }}"
            REGISTRY="${{ env.REGISTRY }}"
            PORT="${{ secrets.UI_APP_PORT || '80' }}"
            
            echo "å¼€å§‹éƒ¨ç½²å‰ç«¯ $MODULE:$VERSION"
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull $REGISTRY/$MODULE:$VERSION
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            if [ "$(docker ps -q -f name=$MODULE)" ]; then
              echo "åœæ­¢æ—§å®¹å™¨..."
              docker stop $MODULE
            fi
            
            if [ "$(docker ps -aq -f name=$MODULE)" ]; then
              echo "åˆ é™¤æ—§å®¹å™¨..."
              docker rm $MODULE
            fi
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name $MODULE \
              -p $PORT:80 \
              --restart unless-stopped \
              --label "version=$VERSION" \
              --label "deployed-at=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "type=frontend" \
              $REGISTRY/$MODULE:$VERSION
            
            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            if curl -f http://localhost:$PORT > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸï¼åº”ç”¨è¿è¡Œåœ¨ç«¯å£ $PORT"
            else
              echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f
            
            echo "ğŸ‰ å‰ç«¯éƒ¨ç½²å®Œæˆï¼"

  # Job 5: é€šçŸ¥
  notify:
    name: å‰ç«¯éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, build, docker-build, deploy]
    if: always() && needs.code-quality.outputs.should-deploy == 'true' && needs.code-quality.outputs.has-ui-changes == 'true'
    
    steps:
      - name: å‘é€é€šçŸ¥
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸé€šçŸ¥"
            # è¿™é‡Œå¯ä»¥æ·»åŠ é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥
          else
            echo "âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥é€šçŸ¥"
            # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
          fi